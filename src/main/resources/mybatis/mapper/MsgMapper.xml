<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xuebei.crm.message.MsgMapper">
    <resultMap id="enclosureApplyMap" type="com.xuebei.crm.message.Apply">
        <id property="applyId" column="enclosure_apply_id"/>
        <result property="applyTime" column="apply_ts"/>
        <result property="applyUserId" column="user_id"/>
        <result property="applyUserName" column="real_nm"/>
        <result property="customerName" column="department_nm"/>
        <result property="customerId" column="customer_dept_id"/>
        <result property="applyDetails" column="apply_reason"/>
    </resultMap>

    <resultMap id="enclosureDelayApplyMap" type="com.xuebei.crm.message.Apply">
        <id property="applyId" column="enclosure_delay_apply_id"/>
        <result property="applyTime" column="apply_ts"/>
        <result property="applyUserId" column="user_id"/>
        <result property="applyUserName" column="real_nm"/>
        <result property="customerName" column="department_nm"/>
        <result property="customerId" column="customer_dept_id"/>
        <result property="applyDetails" column="apply_reason"/>
    </resultMap>

    <select id="searchEnclosureApply" resultMap="enclosureApplyMap">
        select t1.*,t2.department_nm from
            (select t.* from
                (select r1.enclosure_apply_id,r1.customer_dept_id,r1.apply_ts,r1.apply_reason,r2.*
                 from enclosure_apply as r1
                     inner join
                     (select a.user_id,b.real_nm
                      from company_user as a
                          left join crm_user as b
                              on a.crm_user_id = b.crm_user_id
                      where a.company_id =
                            (select company_id from company_user
                            where company_user.user_id = #{userId}
                                  and company_user.is_delete = 0)
                            and a.user_id != #{userId}
                            and a.is_delete = 0
                            and a.`status` = 'PERMITTED') as r2
                         on r1.user_id = r2.user_id
                 where r1.status_cd='APPLYING'
                 order by r1.update_ts desc) as t
            group by t.customer_dept_id) as t1
            left join customer_dept as t2
                on t1.customer_dept_id = t2.customer_dept_id
    </select>
    
    <select id="searchEnclosureDelayApply" resultMap="enclosureDelayApplyMap">
        select p1.*,p2.department_nm from
            (select p.* from
                (select t1.enclosure_delay_apply_id,t1.apply_ts,t1.apply_reason,
                     t2.*
                 from enclosure_delay_apply as t1
                     inner join
                     (select r1.enclosure_apply_id,r1.customer_dept_id,r2.*
                      from enclosure_apply as r1
                          inner join
                          (select a.user_id,b.real_nm
                           from company_user as a
                               left join crm_user as b
                                   on a.crm_user_id = b.crm_user_id
                           where a.company_id =
                                 (select company_id from company_user
                                 where user_id = #{userId})
                                 and a.is_delete = 0
                                 and a.`status` = 'PERMITTED'
                                 and a.user_id != #{userId}) as r2
                              on r1.user_id = r2.user_id) as t2
                         on t1.enclosure_apply_id = t2.enclosure_apply_id
                 where t1.status_cd = 'APPLYING'
                 order by t1.apply_ts) as p
            group by p.customer_dept_id) as p1
            left join customer_dept as p2
                on p1.customer_dept_id = p2.customer_dept_id
    </select>

    <update id="enclosureApplyAgree" parameterType="java.lang.String">
        UPDATE enclosure_apply
        SET status_cd='PERMITTED',update_ts=NOW(),updater_id=#{userId},apply_end_ts=adddate(NOW(),INTERVAL 3 MONTH )
        WHERE enclosure_apply_id = #{enclosureApplyId};
    </update>

    <update id="enclosureApplyDecline" >
        UPDATE enclosure_apply
        SET status_cd='REJECTED',update_ts=NOW(),updater_id=#{userId}
        WHERE enclosure_apply_id = #{enclosureApplyId};
    </update>
    
    <update id="enclosureDelayApplyAgree">
        UPDATE enclosure_delay_apply
        SET status_cd='PERMITTED'
        WHERE enclosure_delay_apply_id = #{enclosureDelayApplyId};
    </update>
    
    <update id="enclosureApplyEndTsExtend" >
        UPDATE enclosure_apply
        SET updater_id=#{userId},update_ts=NOW(),apply_end_ts=adddate(NOW(),INTERVAL 3 MONTH)
        WHERE enclosure_apply_id = (
            SELECT a.enclosure_apply_id
            FROM enclosure_delay_apply as a
            WHERE a.enclosure_delay_apply_id = #{enclosureDelayApplyId}
        )
    </update>

    <update id="enclosureDelayApplyDecline" >
        UPDATE enclosure_delay_apply
        SET status_cd='REJECTED'
        WHERE enclosure_delay_apply_id = #{enclosureDelayApplyId};
    </update>


</mapper>