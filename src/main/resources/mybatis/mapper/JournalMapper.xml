<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xuebei.crm.journal.JournalMapper">
    <resultMap id="journalMap" type="com.xuebei.crm.journal.Journal">
        <id property="journalId" column="journal_id"/>
        <result property="userId" column="user_id"/>
        <result property="type" column="type_cd"/>
        <result property="summary" column="summary"/>
        <result property="plan" column="plan"/>
        <result property="createTs" column="create_ts"/>
        <result property="hasSubmitted" column="has_submitted"/>
        <association property="user" javaType="com.xuebei.crm.user.User">
            <id property="userId" column="user_id"/>
            <result column="real_nm" property="realName"/>
        </association>
    </resultMap>

    <resultMap id="visitMap" type="com.xuebei.crm.journal.VisitRecord">
        <id property="visitId" column="visit_log_id"/>
        <result property="visitType" column="visit_type"/>
        <result property="visitResult" column="visit_result"/>
    </resultMap>

    <resultMap id="userMap" type="com.xuebei.crm.user.User">
        <id property="userId" column="user_id"/>
        <result property="CRMUserId" column="crm_user_id"/>
        <result property="companyId" column="company_id"/>
        <result property="userType" column="user_type"/>
        <result property="realName" column="real_nm"/>
        <result property="tel" column="TEL"/>
        <result property="avatarUrl" column="avatar_url"/>
    </resultMap>
    
    <insert id="createJournal" parameterType="com.xuebei.crm.journal.Journal" useGeneratedKeys="true" keyColumn="journal_id" keyProperty="journalId">
      INSERT INTO journal (
        user_id,
        type_cd,
        plan,
        summary,
        create_ts,
        update_ts,
        has_submitted
      )
      VALUES (
        #{userId},
        #{type},
        #{plan},
        #{summary},
        NOW(),
        NOW(),
        #{hasSubmitted}
      );
    </insert>

    <select id="queryJournalById" resultMap="journalMap">
      SELECT *
      FROM journal
      WHERE journal_id = #{journalId}
    </select>

    <select id="userHasJournal" resultType="java.lang.Boolean">
      SELECT COUNT(journal_id)
      FROM journal
      WHERE journal_id = #{journalId} AND user_id = #{userId}
    </select>

    <update id="updateJournal" parameterType="com.xuebei.crm.journal.Journal">
        UPDATE journal
        SET plan = #{plan},
          summary = #{summary},
          has_submitted = #{hasSubmitted},
          update_ts = NOW()
        WHERE journal_id = #{journalId} AND user_id = #{userId}
    </update>

    <delete id="deleteJournal">
        DELETE FROM journal
        WHERE user_id = #{userId} AND journal_id = #{journalId}
    </delete>

    <delete id="deleteVisitLog">
        DELETE FROM visit_log
        WHERE journal_id = #{journalId}
    </delete>

    <insert id="insertVisitLog" parameterType="com.xuebei.crm.journal.VisitRecord" useGeneratedKeys="true" keyColumn="visit_log_id" keyProperty="visitId">
        INSERT INTO visit_log
        (visit_result, visit_type, journal_id)
        VALUES
            (#{visitResult}, #{visitType}, #{journalId})
    </insert>

    <select id="queryVisitLogs" resultMap="visitMap">
        SELECT * FROM visit_log
        WHERE journal_id = #{journalId}
    </select>

    <delete id="deleteVisitContacts">
        DELETE FROM visit_contacts
        WHERE visit_log_id = #{visitId}
    </delete>

    <insert id="insertVisitContacts">
        INSERT INTO visit_contacts
        (visit_log_id, contacts_id)
        VALUES
            (#{visitId}, #{contactsId})
    </insert>

    <select id="queryVisitContacts" resultType="java.lang.String">
        SELECT contacts_id FROM visit_contacts
        WHERE visit_log_id = #{visitId}
    </select>

    <delete id="deleteJournalReceiver">
        DELETE FROM journal_receiver
        WHERE journal_id = #{journalId};
    </delete>

    <insert id="insertJournalReceiver" parameterType="map">
        INSERT INTO journal_receiver
        (journal_id, receiver_id)
        VALUES
            (#{journalId}, #{receiverId})
    </insert>

    <select id="queryJournalReceiver" resultMap="userMap">
        SELECT *
        FROM journal_receiver LEFT JOIN user_view ON journal_receiver.receiver_id = user_view.user_id
        WHERE journal_id = #{journalId}
    </select>

    <select id="isUserSameCompany" resultType="java.lang.Boolean">
        SELECT COUNT(A.user_id)
        FROM user_view AS A, user_view AS B
        WHERE A.user_id = #{userIdA} AND B.user_id = #{userIdB} AND A.company_id = B.company_id
    </select>

    <select id="searchMyJournal" resultMap="journalMap">
        SELECT j.*, u.real_nm FROM journal j
        INNER JOIN user_view u ON j.user_id = u.user_id
        WHERE j.user_id = #{userId}
        <if test="journalType != null">
            AND j.type_cd = #{journalType}
        </if>
        <if test="startTime != null">
            AND j.create_ts &gt; #{startTime}
        </if>
        <if test="endTime != null">
            AND j.create_ts &lt; #{endTime}
        </if>
    </select>

    <select id="searchReceivedJournal" resultMap="journalMap">
        SELECT j.*, u.real_nm FROM journal j
        INNER JOIN user_view u ON j.user_id = u.user_id
        INNER JOIN journal_receiver r ON j.journal_id = r.journal_id
        WHERE r.receiver_id = #{userId}
        <if test="journalType != null">
            AND j.type_cd = #{journalType}
        </if>
        <if test="startTime != null">
            AND j.create_ts &gt; #{startTime}
        </if>
        <if test="endTime != null">
            AND j.create_ts &lt; #{endTime}
        </if>
    </select>
</mapper>