<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xuebei.crm.opportunity.OpportunityMapper">

    <resultMap id="companyMap" type="com.xuebei.crm.company.Company">
        <id property="companyId" column="company_id"/>
        <result property="companyName" column="com_nm"/>
    </resultMap>

    <resultMap id="opportunityMap" type="com.xuebei.crm.opportunity.Opportunity">
        <id property="opportunityId" column="sales_opportunity_id"/>
        <result property="customerId" column="customer_id"/>
        <result property="opportunityName" column="opportunity_nm"/>
        <result property="salesStatus" column="sales_status"/>
        <result property="amount" column="amount"/>
        <result property="userId" column="user_id"/>
        <result property="create_ts" column="create_ts"/>

    </resultMap>


    <insert id="addSale" parameterType="com.xuebei.crm.opportunity.Opportunity"
            useGeneratedKeys="true" keyColumn="sales_opportunity_id" keyProperty="opportunityId">
        INSERT INTO `crmdb`.`sales_opportunity` (
            `customer_id`, `opportunity_nm`,
            `sales_status`, `amount`, `check_date`, `clinch_date`,
             `content`, `user_id`, `create_ts`, `updater_id`, `update_ts`
        ) VALUES (
            #{customerId},
            #{opportunityName},
            #{salesStatus},
            #{amount},
            #{checkDate},
            #{clinchDate},
            #{content},
            #{userId},
            NOW(),
            #{userId} ,
            NOW()
        )
    </insert>

    <insert id="addOpportunityContact">
        INSERT INTO `crmdb`.`opportunity_contacts` (
            `sales_opportunity_id`, `contacts_id`
        ) VALUES (
            #{opportunityId},
            #{contactId}
        )
    </insert>

    <select id="queryOpportunity" resultMap="opportunityMap">
       SELECT  * FROM sales_opportunity
        <if test="createStart != null">
            AND create_ts > #{createStart}
        </if>
        <if test="createEnd != null">
            AND create_ts &lt;  #{createEnd}
        </if>
        <if test="userId != null and userId != ''">
            AND user_id = #{userId}
        </if>
        <if test="salesStatus != null and salesStatus != 'all'">
            AND sales_status = #{salesStatus}
        </if>
        <if test="customerName != null and customerName != ''">
            AND customer_id = #{customerName}
        </if>
        <if test="scene != null and scene != ''">
            AND user_id = #{scene}
        </if>
        <if test="sortMode != null and sortMode != ''">
            ORDER BY create_ts #{sortMode}
        </if>

    </select>

</mapper>