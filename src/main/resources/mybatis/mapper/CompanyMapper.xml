<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xuebei.crm.company.CompanyMapper">

    <resultMap id="companyMap" type="com.xuebei.crm.company.Company">
        <id property="companyId" column="company_id"/>
        <result property="companyName" column="com_nm"/>
    </resultMap>

    <select id="queryCompanyListByCrmUserId" resultMap="companyMap">
        SELECT
            company.company_id,
            com_nm
        FROM user_view
            LEFT JOIN company ON user_view.company_id = company.company_id
        WHERE user_view.crm_user_id = #{crmUserId};
    </select>

    <select id="queryUserId" resultType="java.lang.String">
        SELECT user_id
        FROM user_view
        WHERE crm_user_id = #{crmUserId} AND company_id = #{companyId};
    </select>

    <select id="queryCompanyIdByUserId" resultType="java.lang.String">
        SELECT company_id
        FROM company_user
        WHERE user_id = #{userId};
    </select>

    <insert id="joinCompany">
        INSERT INTO `crmdb`.`company_user` (
            `user_id`,
            `user_type`,
            `crm_user_id`,
            `company_id`,
            `creator_id`,
            `create_ts`,
            `updater_id`,
            `update_ts`
        )
        VALUES
            (
                #{userId},
                'NORMAL',
                #{crmUserId},
                #{companyId},
                'system',
                NOW(),
                'system',
                NOW()
            );
    </insert>

    <insert id="addCompany">
        INSERT INTO `crmdb`.`company` (
            `company_id`,
            `com_nm`,
            `creator_id`,
            `create_ts`,
            `updater_id`,
            `update_ts`
        )
        VALUES (
            #{companyId},
            #{companyName},
            'system',
            NOW(),
            'system',
            NOW()
        )

    </insert>

    <select id="getUserId">
        SELECT crm_user_id FROM crm_user
        WHERE real_nm = #{userName} AND TEL = #{tel}
    </select>

</mapper>