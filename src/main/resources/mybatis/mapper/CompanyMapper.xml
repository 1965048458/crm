<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xuebei.crm.company.CompanyMapper">

    <resultMap id="companyMap" type="com.xuebei.crm.company.Company">
        <id property="companyId" column="company_id"/>
        <result property="companyName" column="com_nm"/>
    </resultMap>

    <resultMap id="companyListMap" type="com.xuebei.crm.company.Company">
        <id property="companyId" column="company_id"/>
        <result property="companyName" column="com_nm"/>
        <result property="status" column="status"/>
    </resultMap>

    <resultMap id="companyApplyMap" type="com.xuebei.crm.company.CompanyUser">
        <id property="userId" column="user_id"/>
        <result property="crmUserName" column="real_nm"/>
        <result property="tel" column="tel"/>
        <result property="companyId" column="company_id"/>
        <result property="createTs" column="create_ts"/>
    </resultMap>


    <select id="queryCompanyList" resultMap="companyListMap">
        SELECT
            c.company_id,
            c.com_nm,
            cu.status
        FROM company c
        INNER JOIN company_user cu ON c.company_id = cu.company_id
        WHERE cu.crm_user_id=#{crmUserId};
    </select>

    <select id="queryCompanyListByCrmUserId" resultMap="companyMap">
        SELECT
        company.company_id,
        com_nm
        FROM user_view
        LEFT JOIN company ON user_view.company_id = company.company_id
        WHERE user_view.crm_user_id = #{crmUserId};
    </select>

    <select id="queryUserId" resultType="java.lang.String">
        SELECT user_id
        FROM user_view
        WHERE crm_user_id = #{crmUserId} AND company_id = #{companyId};
    </select>

    <select id="queryUserType" resultType="java.lang.String">
        SELECT  user_type
        FROM company_user
        WHERE user_id = #{userId};
    </select>

    <select id="queryCompanyIdByUserId" resultType="java.lang.String">
        SELECT company_id
        FROM company_user
        WHERE user_id = #{userId};
    </select>

    <insert id="joinCompany">
        INSERT INTO `company_user` (
            `user_id`,
            `user_type`,
            `crm_user_id`,
            `company_id`,
            `creator_id`,
            `create_ts`,
            `updater_id`,
            `update_ts`
        )
        VALUES
            (
                #{userId},
                'NORMAL',
                #{crmUserId},
                #{companyId},
                'system',
                NOW(),
                'system',
                NOW()
            );
    </insert>

    <insert id="addCompany">
        INSERT INTO `company` (
            `company_id`,
            `com_nm`,
            `creator_id`,
            `create_ts`,
            `updater_id`,
            `update_ts`
        )
        VALUES (
            #{companyId},
            #{companyName},
            'system',
            NOW(),
            'system',
            NOW()
        )

    </insert>

    <select id="getUserId" resultType="java.lang.String">
        SELECT crm_user_id FROM crm_user
        WHERE real_nm = #{userName} AND TEL = #{tel}
    </select>

    <select id="queryCompany" resultMap="companyMap">
        SELECT company_id,com_nm FROM company WHERE
        com_nm LIKE CONCAT('%', #{name}, '%')
    </select>

    <select id="queryCompanyComplete" resultMap="companyMap">
        SELECT company_id,com_nm FROM company WHERE
        com_nm = #{name} ;
    </select>

    <select id="queryApplyStatus" resultType="java.lang.String">
        SELECT status FROM company_user WHERE
        crm_user_id = #{crmUserId} AND company_id = #{companyId};
    </select>

    <select id="queryApplyStaff" resultMap="companyApplyMap">
       select com.user_id,cu.real_nm, cu.tel,com.create_ts,com.company_id from crm_user cu
         INNER JOIN company_user com ON com.crm_user_id = cu.crm_user_id AND com.company_id =(select
			company_id from company_user where user_id =#{userId} AND
          user_type = 'ADMIN')
         where com.status = 'PENDING'
    </select>

    <update id="agreeApply" parameterType="java.lang.String">
        UPDATE company_user as cu SET cu.update_ts= NOW(),
       cu.status='PERMITTED',
       cu.updater_id = #{crmUserId}
        WHERE cu.user_id=#{userId};
    </update>

    <update id="refuseApply" parameterType="java.lang.String">
        UPDATE company_user as cu SET cu.update_ts= NOW(),
        cu.status='REFUSE',
        cu.updater_id = #{crmUserId}
        WHERE cu.user_id=#{userId};
    </update>

    <select id="queryCompanyName" resultType="java.lang.String">
       select com_nm from company where company_id = (
        select company_id from company_user where user_id = #{userId});
    </select>

    <select id="queryStatus" resultType="java.lang.String">
        select status from company_user where user_id = #{userId};
    </select>

    <select id="queryCrmUserId" resultType="java.lang.String">
        select crm_user_id from company_user where user_id = #{userId};
    </select>


</mapper>